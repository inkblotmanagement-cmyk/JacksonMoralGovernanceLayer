(include the refined implementation code provided earlier)